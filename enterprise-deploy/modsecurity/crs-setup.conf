# OWASP ModSecurity Core Rule Set (CRS) Configuration
# Optimized for Laravel applications

# -- Paranoia Level ----------------------------------------------------------
# Level 1 (default) - Basic protection, fewer false positives
# Level 2 - Moderate protection
# Level 3 - High protection
# Level 4 - Maximum protection, more false positives
SecAction \
  "id:900000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.paranoia_level=1"

# -- Execution Mode ----------------------------------------------------------
# On - Block malicious requests
# DetectionOnly - Log only, don't block (useful for testing)
SecAction \
  "id:900001,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.blocking_paranoia_level=1"

# -- Anomaly Scoring ---------------------------------------------------------
# Inbound threshold (requests from users to server)
# Default: 5 (lower = stricter)
SecAction \
  "id:900110,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.inbound_anomaly_score_threshold=5"

# Outbound threshold (responses from server to users)
# Default: 4
SecAction \
  "id:900111,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.outbound_anomaly_score_threshold=4"

# -- HTTP Policy -------------------------------------------------------------
# Allowed HTTP versions
SecAction \
  "id:900230,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

# Allowed request methods
SecAction \
  "id:900240,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# Allowed content types (for POST/PUT requests)
SecAction \
  "id:900250,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# Restricted file extensions (uploads)
SecAction \
  "id:900260,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# Restricted file headers (uploads)
SecAction \
  "id:900270,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/'"

# Static resource extensions (will have reduced inspection)
SecAction \
  "id:900280,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:'tx.static_extensions=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/ /.woff/ /.woff2/ /.ttf/ /.eot/'"

# -- Application-specific settings -------------------------------------------
# Set application type (helps with rule tuning)
SecAction \
  "id:900290,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.crs_exclusions_laravel=1"
