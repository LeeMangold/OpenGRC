# ModSecurity Configuration
# Based on recommended settings with optimizations for Laravel

# -- Rule engine initialization ----------------------------------------------
SecRuleEngine On

# -- Request body handling ---------------------------------------------------
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject
SecRequestBodyJsonDepthLimit 512

# -- Response body handling --------------------------------------------------
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# -- Filesystem configuration ------------------------------------------------
SecDataDir /tmp/modsecurity
SecTmpDir /tmp/modsecurity
SecUploadDir /tmp/modsecurity/upload
SecUploadKeepFiles Off

# -- Debug log configuration -------------------------------------------------
SecDebugLog /var/log/apache2/modsec_debug.log
SecDebugLogLevel 0

# -- Audit log configuration -------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/apache2/modsec_audit.log

# -- Miscellaneous -----------------------------------------------------------
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine On

# -- Performance optimizations -----------------------------------------------
SecStreamOutBodyInspection Off
SecRulePerformanceTime 10000

# -- Additional security settings --------------------------------------------
SecServerSignature "Apache"
SecComponentSignature "ModSecurity"

# -- Collection timeout ------------------------------------------------------
SecCollectionTimeout 600

# -- Unicode mapping ---------------------------------------------------------
# Handle UTF-8 properly for international characters
SecUnicodeCodePage 20127

# -- PCRE Limits (prevent ReDoS) ---------------------------------------------
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000
