# ModSecurity Exclusions for Laravel Applications
# These rules prevent false positives common in Laravel apps

# ==============================================================================
# Laravel CSRF Token Exclusions
# ==============================================================================
# Laravel sends CSRF tokens in POST requests which can trigger SQL injection rules
SecRule REQUEST_FILENAME "@beginsWith /app" \
    "id:9001000,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=942100;ARGS:_token,\
    ctl:ruleRemoveTargetById=942200;ARGS:_token,\
    ctl:ruleRemoveTargetById=942260;ARGS:_token,\
    ctl:ruleRemoveTargetById=942300;ARGS:_token,\
    ctl:ruleRemoveTargetById=942370;ARGS:_token,\
    ctl:ruleRemoveTargetById=942430;ARGS:_token,\
    ctl:ruleRemoveTargetById=942440;ARGS:_token"

# ==============================================================================
# Laravel API Routes
# ==============================================================================
# Exclude JSON payloads in API routes from certain rules
SecRule REQUEST_FILENAME "@beginsWith /api" \
    "id:9001100,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY"

# ==============================================================================
# Filament Admin Panel Exclusions
# ==============================================================================
# Filament uses complex JSON payloads that can trigger false positives
SecRule REQUEST_FILENAME "@beginsWith /admin" \
    "id:9001200,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=942100;ARGS,\
    ctl:ruleRemoveTargetById=942200;ARGS,\
    ctl:ruleRemoveTargetById=942260;ARGS"

SecRule REQUEST_FILENAME "@beginsWith /app" \
    "id:9001210,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=942100;ARGS,\
    ctl:ruleRemoveTargetById=942200;ARGS,\
    ctl:ruleRemoveTargetById=942260;ARGS"

# ==============================================================================
# Livewire Component Exclusions
# ==============================================================================
# Livewire sends component states that can trigger XSS/injection rules
SecRule REQUEST_FILENAME "@rx ^/(livewire|admin|app)" \
    "id:9001300,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:components,\
    ctl:ruleRemoveTargetById=941110;ARGS:components,\
    ctl:ruleRemoveTargetById=941160;ARGS:components,\
    ctl:ruleRemoveTargetById=941170;ARGS:components,\
    ctl:ruleRemoveTargetById=941180;ARGS:components,\
    ctl:ruleRemoveTargetById=941200;ARGS:components,\
    ctl:ruleRemoveTargetById=941210;ARGS:components,\
    ctl:ruleRemoveTargetById=941300;ARGS:components,\
    ctl:ruleRemoveTargetById=941310;ARGS:components,\
    ctl:ruleRemoveTargetById=941330;ARGS:components,\
    ctl:ruleRemoveTargetById=941340;ARGS:components"

# Livewire serverMemo parameter
SecRule REQUEST_FILENAME "@rx ^/(livewire|admin|app)" \
    "id:9001310,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=942100;ARGS:serverMemo,\
    ctl:ruleRemoveTargetById=942200;ARGS:serverMemo,\
    ctl:ruleRemoveTargetById=942260;ARGS:serverMemo,\
    ctl:ruleRemoveTargetById=942300;ARGS:serverMemo,\
    ctl:ruleRemoveTargetById=942370;ARGS:serverMemo"

# ==============================================================================
# Laravel Session Data
# ==============================================================================
# Session cookies can contain serialized data
SecRule REQUEST_COOKIES:laravel_session "@rx .*" \
    "id:9001400,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=942100;REQUEST_COOKIES:laravel_session,\
    ctl:ruleRemoveTargetById=942200;REQUEST_COOKIES:laravel_session,\
    ctl:ruleRemoveTargetById=942260;REQUEST_COOKIES:laravel_session,\
    ctl:ruleRemoveTargetById=942370;REQUEST_COOKIES:laravel_session"

SecRule REQUEST_COOKIES:XSRF-TOKEN "@rx .*" \
    "id:9001410,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=942100;REQUEST_COOKIES:XSRF-TOKEN,\
    ctl:ruleRemoveTargetById=942200;REQUEST_COOKIES:XSRF-TOKEN,\
    ctl:ruleRemoveTargetById=942260;REQUEST_COOKIES:XSRF-TOKEN,\
    ctl:ruleRemoveTargetById=942370;REQUEST_COOKIES:XSRF-TOKEN"

# ==============================================================================
# Rich Text Editors (TinyMCE, CKEditor, etc.)
# ==============================================================================
# Rich text content can legitimately contain HTML/JS
SecRule ARGS_NAMES "@rx (content|description|body|message|text|notes)" \
    "id:9001500,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetByTag=attack-xss;ARGS,\
    ctl:ruleRemoveTargetById=941100;ARGS,\
    ctl:ruleRemoveTargetById=941110;ARGS,\
    ctl:ruleRemoveTargetById=941160;ARGS,\
    ctl:ruleRemoveTargetById=941170;ARGS"

# ==============================================================================
# File Uploads
# ==============================================================================
# Allow legitimate file uploads while blocking dangerous extensions
SecRule REQUEST_FILENAME "@rx ^/(admin|app|upload)" \
    "id:9001600,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920273;FILES"

# ==============================================================================
# Laravel Telescope & Debugging Tools
# ==============================================================================
SecRule REQUEST_FILENAME "@beginsWith /telescope" \
    "id:9001700,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=942100;ARGS,\
    ctl:ruleRemoveTargetById=942200;ARGS"

# ==============================================================================
# Search and Filter Parameters
# ==============================================================================
# Search queries can contain special characters
SecRule ARGS_NAMES "@rx (search|filter|query|q)" \
    "id:9001800,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=942100;ARGS,\
    ctl:ruleRemoveTargetById=942200;ARGS,\
    ctl:ruleRemoveTargetById=942260;ARGS"

# ==============================================================================
# JSON Payloads
# ==============================================================================
# Complex JSON structures in request bodies
SecRule REQUEST_HEADERS:Content-Type "@rx application/json" \
    "id:9001900,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY"
