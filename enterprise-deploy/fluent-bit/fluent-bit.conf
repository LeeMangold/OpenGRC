# Fluent Bit Configuration for OpenGRC
# Collects logs from multiple sources and forwards to OpenSearch with ECS formatting

# ==========================================
# SERVICE Configuration
# ==========================================
[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# ==========================================
# INPUT - Laravel Application Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/www/html/storage/logs/laravel.log
    Tag               laravel
    Refresh_Interval  5
    Skip_Empty_Lines  On

# ==========================================
# INPUT - PHP-FPM Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/php8.3-fpm.log
    Tag               php-fpm
    Refresh_Interval  5
    Skip_Empty_Lines  On

# ==========================================
# INPUT - Apache Access Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/apache2/access.log
    Tag               apache-access
    Parser            apache
    Refresh_Interval  5
    Skip_Empty_Lines  On

# ==========================================
# INPUT - Apache Error Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/apache2/error.log
    Tag               apache-error
    Refresh_Interval  5
    Skip_Empty_Lines  On

# ==========================================
# INPUT - System Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/syslog
    Tag               syslog
    Refresh_Interval  5
    Skip_Empty_Lines  On

# ==========================================
# FILTER - Add ECS Metadata (All Logs)
# ==========================================
[FILTER]
    Name                modify
    Match               *
    Add                 ecs_version 8.11.0
    Add                 service_name opengrc
    Add                 service_type application

# ==========================================
# FILTER - Laravel Log Metadata
# ==========================================
[FILTER]
    Name                modify
    Match               laravel
    Add                 dataset laravel.log
    Add                 logger laravel

# ==========================================
# FILTER - PHP-FPM Log Metadata
# ==========================================
[FILTER]
    Name                modify
    Match               php-fpm
    Add                 dataset php.fpm
    Add                 logger php-fpm

# ==========================================
# FILTER - Apache Access Log Metadata
# ==========================================
[FILTER]
    Name                modify
    Match               apache-access
    Add                 dataset apache.access
    Add                 logger apache
    Add                 category web
    Add                 type access

# ==========================================
# FILTER - Apache Error Log Metadata
# ==========================================
[FILTER]
    Name                modify
    Match               apache-error
    Add                 dataset apache.error
    Add                 logger apache
    Add                 category web
    Add                 type error

# ==========================================
# FILTER - Syslog Metadata
# ==========================================
[FILTER]
    Name                modify
    Match               syslog
    Add                 dataset system.syslog
    Add                 logger syslog

# ==========================================
# FILTER - Transform Apache Logs to ECS
# ==========================================
[FILTER]
    Name                lua
    Match               apache-access
    script              /etc/fluent-bit/ecs-transform.lua
    call                transform_to_ecs

# ==========================================
# OUTPUT - OpenSearch
# ==========================================
[OUTPUT]
    Name              opensearch
    Match             *
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASSWORD}
    Index             logs
    Type              _doc
    tls               On
    tls.verify        Off
    Suppress_Type_Name On