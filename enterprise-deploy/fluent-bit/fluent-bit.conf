# Fluent Bit Configuration for OpenGRC on DigitalOcean App Platform
# Routes logs to separate OpenSearch indices with proper parsing

# ==========================================
# SERVICE Configuration
# ==========================================
[SERVICE]
    Flush             1
    Daemon            Off
    Log_Level         info
    Parsers_File      parsers.conf
    HTTP_Server       On
    HTTP_Listen       0.0.0.0
    HTTP_Port         2020
    Health_Check      On
    storage.path      /tmp/flb-storage/
    storage.sync      normal
    storage.checksum  off
    storage.max_chunks_up  128
    storage.backlog.mem_limit  5M

# ==========================================
# INPUT - Laravel Application Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /workspace/storage/logs/laravel.log
    Tag               opengrc.app
    Parser            laravel_json
    DB                /tmp/flb_laravel.db
    Mem_Buf_Limit     10MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# ==========================================
# INPUT - PHP-FPM Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/php8.3-fpm.log
    Tag               system.php-fpm
    Parser            php_fpm
    DB                /tmp/flb_php_fpm.db
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# ==========================================
# INPUT - Apache Access Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/apache2/access.log
    Tag               apache.access
    Parser            apache_access_forwarded
    DB                /tmp/flb_apache_access.db
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  5

# ==========================================
# INPUT - Apache Error Logs
# ==========================================
[INPUT]
    Name              tail
    Path              /var/log/apache2/error.log
    Tag               apache.error
    Parser            apache_error
    DB                /tmp/flb_apache_error.db
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Multiline         On
    Parser_Firstline  apache_error

# ==========================================
# FILTER - Add Common Metadata (All Logs)
# ==========================================
[FILTER]
    Name              record_modifier
    Match             *
    Record            app_name ${APP_NAME}
    Record            app_env ${APP_ENV}
    Record            app_url ${APP_URL}
    Record            service_name opengrc
    Record            deployment_type digitalocean-app-platform

# ==========================================
# FILTER - Parse Laravel JSON Logs
# ==========================================
[FILTER]
    Name              parser
    Match             opengrc.app
    Key_Name          log
    Parser            laravel_json_detailed
    Reserve_Data      On
    Preserve_Key      Off

# ==========================================
# FILTER - Enrich Laravel Logs
# ==========================================
[FILTER]
    Name              modify
    Match             opengrc.app
    Add               service.type application
    Add               log.logger laravel
    Add               environment ${APP_ENV}
    Rename            level log.level
    Rename            msg message

# ==========================================
# FILTER - Parse & Enrich Apache Access Logs
# ==========================================
[FILTER]
    Name              modify
    Match             apache.access
    Add               service.type web
    Add               event.dataset apache.access
    Add               event.category web
    Add               environment ${APP_ENV}
    Rename            remote_ip client.ip
    Rename            status http.response.status_code
    Rename            body_bytes_sent http.response.body.bytes
    Rename            request_method http.request.method
    Rename            request_uri url.path
    Rename            http_user_agent user_agent.original

# ==========================================
# FILTER - Parse & Enrich Apache Error Logs
# ==========================================
[FILTER]
    Name              modify
    Match             apache.error
    Add               service.type web
    Add               event.dataset apache.error
    Add               event.category web
    Add               environment ${APP_ENV}
    Rename            severity log.level

# ==========================================
# FILTER - Enrich System Logs
# ==========================================
[FILTER]
    Name              modify
    Match             system.*
    Add               service.type system
    Add               event.dataset system.syslog
    Add               environment ${APP_ENV}

# ==========================================
# OUTPUT - OpenGRC Application Logs
# ==========================================
[OUTPUT]
    Name              opensearch
    Match             opengrc.app
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASSWORD}
    Index             opengrc-app
    Logstash_Format   On
    Logstash_Prefix   opengrc-app
    Logstash_DateFormat %Y.%m.%d
    Type              _doc
    TLS               On
    TLS.Verify        Off
    Suppress_Type_Name On
    Buffer_Size       4KB
    Retry_Limit       5
    Include_Tag_Key   On
    Tag_Key           _tag

# ==========================================
# OUTPUT - Apache Access Logs
# ==========================================
[OUTPUT]
    Name              opensearch
    Match             apache.access
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASSWORD}
    Index             apache-access
    Logstash_Format   On
    Logstash_Prefix   apache-access
    Logstash_DateFormat %Y.%m.%d
    Type              _doc
    TLS               On
    TLS.Verify        Off
    Suppress_Type_Name On
    Buffer_Size       4KB
    Retry_Limit       5

# ==========================================
# OUTPUT - Apache Error Logs
# ==========================================
[OUTPUT]
    Name              opensearch
    Match             apache.error
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASSWORD}
    Index             apache-error
    Logstash_Format   On
    Logstash_Prefix   apache-error
    Logstash_DateFormat %Y.%m.%d
    Type              _doc
    TLS               On
    TLS.Verify        Off
    Suppress_Type_Name On
    Buffer_Size       4KB
    Retry_Limit       5

# ==========================================
# OUTPUT - System Logs
# ==========================================
[OUTPUT]
    Name              opensearch
    Match             system.*
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASSWORD}
    Index             system-logs
    Logstash_Format   On
    Logstash_Prefix   system-logs
    Logstash_DateFormat %Y.%m.%d
    Type              _doc
    TLS               On
    TLS.Verify        Off
    Suppress_Type_Name On
    Buffer_Size       4KB
    Retry_Limit       5